---
title: "Data Wrangling on Multiple Tables"
author: "Gregory J. Matthews"
date: "9/23/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Inner Join
Inner joins return results if the keys are matched in BOTH tables.

```{r}
library(tidyverse)
library(mdsr)
library(nycflights13)

head(airlines)
head(flights)

```

```{r}
#Old school
flights_joined <- merge(flights, airlines, by.x = "carrier", by.y = "carrier")
glimpse(flights_joined)
```

```{r}
flights_joined %>% 
  select(carrier, name, flight, origin, dest) %>% 
  head(3)
```

```{r}
#Tidyverse way
flights_joined <- flights %>% 
  inner_join(airlines, by = c("carrier" = "carrier"))
glimpse(flights_joined)
```

```{r}
flights_joined %>% 
  select(carrier, name, flight, origin, dest) %>% 
  head(3)
```

```{r}
#Same number of rows.  Why?  
nrow(flights)
nrow(flights_joined)
```

"In an inner_join(), the result set contains only those rows that have matches in both tables. In this case, all of the rows in flights have exactly one corresponding entry in airlines, so the number of rows in flights_joined is the same as the number of rows in flights (this will not always be the case)."

***It is always a good idea to carefully check that the number of rows returned by a join operation is what you expected. In particular, you should carefully check for rows in one table that matched to more than one row in the other table***

## Left Join

"Here the rows of the first table are always returned, regardless of whether there is a match in the second table."

```{r}
#Airports in the pacific time zone only 
airports_pt <- airports %>%
  filter(tz == -8) %>% select(faa, name, tz)
nrow(airports_pt)
head(airports_pt)
```

```{r}
#If we do inner join
nyc_dests_pt <- flights %>% 
  inner_join(airports_pt, by = c("dest" = "faa")) %>% select(name, tz, dest, dep_time,sched_dep_time, arr_time, sched_arr_time, carrier)
head(nyc_dests_pt)
```

```{r}
#Notice these are different.  
#key variable needs to be in BOTH data sets to get returned.  
nrow(flights)
nrow(nyc_dests_pt)
```


```{r}
nyc_dests <- flights %>% 
  left_join(airports_pt, by = c("dest" = "faa"))
```

```{r}
#Notice these are the same!
nrow(flights)
nrow(nyc_dests)
nyc_dests %>%
  summarize(
    num_flights = n(),
    num_flights_pt = sum(!is.na(name)),
    num_flights_not_pt = sum(is.na(name))
  )
```


```{r}
library(Lahman)
#Let's look at Manny Ramirez
manny <- Batting %>%
  filter(playerID == "ramirma02")
nrow(manny)

People %>% 
  filter(nameLast == "Ramirez" & nameFirst == "Manny")

#Question 1: How many years did Manny Ramirez hit more than 30 HRs?
#Question 2: In terms of number of HRs hit, what AGES were his five best? 
#Question 3: What fraction of total homeruns in the league did Manny hit in each of his seasons?   

```

```{r}
manny_people <- People %>% 
  filter(nameLast == "Ramirez" & nameFirst == "Manny")


manny %>% group_by(yearID) %>% summarise(HRt = sum(HR)) %>% filter(HRt > 30)

#Ages
manny %>% left_join(manny_people, by = c("playerID" = "playerID")) %>% mutate(age = yearID - birthYear) %>% group_by(age) %>% summarise(HRt = sum(HR)) %>% arrange(desc(HRt))

#
lg <- Batting %>% 
  group_by(yearID) %>% summarise(HRt_league = sum(HR))

manny_tot <- manny %>% group_by(yearID) %>% summarise(HRt_manny = sum(HR)) 
manny_tot %>% left_join(lg, by = c("yearID" = "yearID")) %>% mutate(fraction = HRt_manny/HRt_league) %>% arrange(desc(fraction))


```

Use the Batting, Pitching, and People tables in the Lahman package to answer the following questions.

 - Name every player in baseball history who has accumulated at least 300 home runs (HR) and at least 300 stolen bases (SB). You can find the first and last name of the player in the People data frame. Join this to your result along with the total home runs and total bases stolen for each of these elite players.

 - Similarly, name every pitcher in baseball history who has accumulated at least 300 wins (W) and at least 3,000 strikeouts (SO).

 - Identify the name and year of every player who has hit at least 50 home runs in a single season. Which player had the lowest batting average in that season?

```{r}
library(Lahman)
head(People)
head(Batting)
head(Pitching)
```

